# 五文件入库实施计划

## 一、实施目标

完成5个Excel文件的入库工作，实现60-70%的核心业务数据覆盖，快速上线核心功能。

## 二、实施范围

### 2.1 文件清单
1. 涌益周度数据.xlsx（65个sheet）
2. 涌益日度数据.xlsx（8个sheet）
3. lh_ftr.xlsx（期货数据）
4. lh_opt.xlsx（期权数据）
5. 钢联自动更新模板.xlsx（7个sheet）

### 2.2 需求覆盖范围
- ✅ A类需求：全国重点数据（85-90%覆盖）
- ✅ B类需求：重点省区汇总（90%覆盖）
- ⚠️ C类需求：期货市场数据（70-80%覆盖，需派生计算）
- ❌ D类需求：集团企业统计（5-10%覆盖，数据缺失）
- ❌ E类需求：官方数据汇总（25-30%覆盖，部分数据缺失）

## 三、分阶段实施计划

### Phase 1: 数据模型完善（1-2天）

#### 1.1 检查现有模型（0.5天）

**任务清单：**
- [ ] 检查所有表是否已创建迁移脚本
  - [ ] `fact_observation` - 观测事实表
  - [ ] `fact_observation_tag` - 标签表
  - [ ] `dim_location` - 地理位置维度表
  - [ ] `dim_location_alias` - 地理位置别名表
  - [ ] `dim_metric` - 指标维度表
  - [ ] `dim_geo` - 地理维度表
  - [ ] `dim_source` - 数据源维度表
  - [ ] `fact_futures_daily` - 期货日度表
  - [ ] `fact_options_daily` - 期权日度表

- [ ] 检查索引是否完整
  - [ ] `fact_observation`表的索引
  - [ ] `fact_observation_tag`表的索引
  - [ ] 其他表的索引

- [ ] 检查外键约束是否正确
  - [ ] 所有外键关系
  - [ ] 级联删除规则

**交付物：**
- 数据模型检查报告
- 缺失的迁移脚本（如有）

#### 1.2 补充缺失功能（0.5-1天）

**任务清单：**
- [ ] 确认`fact_observation_tag`写入逻辑
  - [ ] 检查`observation_upserter.py`是否支持标签写入
  - [ ] 实现标签写入功能（如缺失）
  - [ ] 实现批量标签写入优化

- [ ] 确认`dim_location`初始化数据
  - [ ] 检查是否有初始化脚本
  - [ ] 创建省/市/县三级地理数据初始化脚本
  - [ ] 创建交割地市数据初始化脚本

- [ ] 确认`dim_metric`指标字典完整性
  - [ ] 检查核心指标是否已定义
  - [ ] 补充缺失的指标定义
  - [ ] 创建指标初始化脚本

**交付物：**
- 标签写入功能代码
- 地理数据初始化脚本
- 指标字典初始化脚本

#### 1.3 测试数据模型（0.5天）

**任务清单：**
- [ ] 创建测试数据
- [ ] 验证表结构和约束
- [ ] 验证索引性能
- [ ] 验证外键关系

**交付物：**
- 数据模型测试报告

### Phase 2: 导入器实现（3-5天）

#### 2.1 完善现有导入器（1-2天）

**2.1.1 期货/期权导入器（0.5天）**

**任务清单：**
- [ ] 验证`futures_ingestor.py`功能
  - [ ] 测试导入lh_ftr.xlsx
  - [ ] 验证数据写入`fact_futures_daily`
  - [ ] 验证数据完整性

- [ ] 验证`options_ingestor.py`功能
  - [ ] 测试导入lh_opt.xlsx
  - [ ] 验证数据写入`fact_options_daily`
  - [ ] 验证IV字段正确性

**交付物：**
- 期货/期权导入器测试报告

**2.1.2 钢联导入器（0.5天）**

**任务清单：**
- [ ] 验证`ganglian_daily_ingestor.py`功能
  - [ ] 测试导入钢联自动更新模板.xlsx
  - [ ] 验证7个sheet全部支持
  - [ ] 确认数据写入`fact_observation`
  - [ ] 确认标签写入`fact_observation_tag`

**交付物：**
- 钢联导入器测试报告

**2.1.3 涌益日度导入器（0.5天）**

**任务清单：**
- [ ] 验证`yongyi_daily_ingestor.py`功能
  - [ ] 测试导入涌益日度数据.xlsx
  - [ ] 验证8个sheet全部支持
  - [ ] 确认复杂表头解析正确
  - [ ] 确认数据写入`fact_observation`
  - [ ] 确认标签写入`fact_observation_tag`

**交付物：**
- 涌益日度导入器测试报告

**2.1.4 涌益周度导入器（1-2天）**

**任务清单：**
- [ ] 分析当前实现状态
  - [ ] 检查已支持的sheet数量
  - [ ] 检查缺失的sheet

- [ ] 扩展导入器支持更多sheet
  - [ ] 实现新parser类型（如需要）
  - [ ] 补充sheet配置
  - [ ] 测试新sheet导入

- [ ] 优化导入器性能
  - [ ] 批量插入优化
  - [ ] 错误处理优化
  - [ ] 日志记录优化

**交付物：**
- 涌益周度导入器扩展代码
- 涌益周度导入器测试报告

#### 2.2 实现新Parser（1-2天）

**需要实现的Parser类型：**

**2.2.1 MONTHLY_AUTO Parser（0.5天）**
- [ ] 实现月度数据自动识别逻辑
- [ ] 按header判断省份列
- [ ] 支持全国和省级数据
- [ ] 测试验证

**2.2.2 CROSS_SECTION_TABLE Parser（0.5天）**
- [ ] 实现横截面数据表解析
- [ ] 支持快照数据（as_of_date）
- [ ] 支持省份列识别
- [ ] 测试验证

**2.2.3 PERIOD_STRING_ROWS_MULTI_METRIC Parser（0.5天）**
- [ ] 实现周期字符串行多指标解析
- [ ] 支持日期区间字符串解析
- [ ] 支持多指标提取
- [ ] 测试验证

**2.2.4 MONTH_ROW_YEAR_COL_MATRIX Parser（0.5天）**
- [ ] 实现月度行年度列矩阵解析
- [ ] 转换为时间序列数据
- [ ] 支持多指标提取
- [ ] 测试验证

**2.2.5 RAW_TABLE_STORE_ONLY Parser（0.5天）**
- [ ] 实现原始表存储逻辑
- [ ] 数据写入raw_layer
- [ ] 支持后续结构化处理
- [ ] 测试验证

**交付物：**
- 5个新Parser实现代码
- Parser测试报告

#### 2.3 实现标签写入逻辑（0.5天）

**任务清单：**
- [ ] 在`observation_upserter.py`中添加标签写入逻辑
  - [ ] 从`tags_json`提取标签
  - [ ] 写入`fact_observation_tag`表
  - [ ] 实现批量写入优化

- [ ] 测试标签写入功能
  - [ ] 单元测试
  - [ ] 集成测试
  - [ ] 性能测试

**交付物：**
- 标签写入功能代码
- 标签写入测试报告

#### 2.4 测试导入器（1天）

**任务清单：**
- [ ] 单元测试
  - [ ] 每个导入器的单元测试
  - [ ] 每个Parser的单元测试
  - [ ] 覆盖率要求：>80%

- [ ] 集成测试
  - [ ] 端到端导入测试
  - [ ] 数据完整性测试
  - [ ] 错误处理测试

- [ ] 性能测试
  - [ ] 大数据量导入测试
  - [ ] 性能瓶颈分析
  - [ ] 优化建议

**交付物：**
- 导入器测试报告
- 性能测试报告

### Phase 3: 配置完善（1-2天）

#### 3.1 补充涌益周度配置（1-1.5天）

**任务清单：**
- [ ] 分析当前配置状态
  - [ ] 检查已配置的sheet
  - [ ] 检查缺失的sheet

- [ ] 补充缺失sheet配置
  - [ ] 为每个sheet创建配置
  - [ ] 定义parser类型
  - [ ] 定义指标映射
  - [ ] 定义地理映射

- [ ] 验证配置正确性
  - [ ] 配置语法检查
  - [ ] 配置逻辑验证
  - [ ] 导入测试验证

**配置优先级：**
1. **优先级1（核心sheet，已部分配置）：**
   - 周度-商品猪出栏价
   - 周度-体重
   - 周度-屠宰厂宰前活猪重
   - 周度-养殖利润最新
   - 周度-冻品库存
   - 周度-毛白价差
   - 周度-50公斤二元母猪价格
   - 周度-规模场15公斤仔猪出栏价
   - 周度-淘汰母猪价格
   - 周度-宰后结算价
   - 周度-猪肉价（前三等级白条均价）
   - 周度-屠宰企业日度屠宰量

2. **优先级2（重要sheet，需补充配置）：**
   - 周度-体重拆分
   - 周度-各体重段价差
   - 周度-当期、预期成本
   - 周度-河南屠宰白条成本
   - 周度-冻品库存多样本
   - 周度-猪肉产品价格
   - 育肥全价料价格
   - 高频仔猪、母猪

3. **优先级3（月度数据sheet）：**
   - 月度-能繁母猪存栏量
   - 月度-能繁母猪存栏（2020年2月新增）
   - 月度-小猪存栏（2020年5月新增）
   - 月度-大猪存栏（2020年5月新增）
   - 月度-商品猪出栏量
   - 月度-小猪（50公斤以下）存栏
   - 月度-二元三元能繁比例
   - 月度-屠宰企业开工率

4. **优先级4（其他sheet）：**
   - 其他周度数据sheet
   - 横截面数据sheet
   - 原始数据sheet（RAW_TABLE_STORE_ONLY）

**交付物：**
- 完整的`ingest_profile_yongyi_weekly_v1.json`配置文件
- 配置文档说明

#### 3.2 完善指标映射规则（0.5天）

**任务清单：**
- [ ] 检查`indicator_mappings.json`完整性
  - [ ] 检查核心指标是否已映射
  - [ ] 检查指标代码是否规范

- [ ] 补充缺失的指标映射
  - [ ] 为新增sheet添加指标映射
  - [ ] 统一指标命名规范
  - [ ] 补充指标元数据（单位、描述等）

- [ ] 验证映射规则正确性
  - [ ] 映射逻辑验证
  - [ ] 导入测试验证
  - [ ] 查询测试验证

**交付物：**
- 完整的`indicator_mappings.json`文件
- 指标映射文档说明

### Phase 4: 测试与验证（1-2天）

#### 4.1 数据导入测试（0.5天）

**任务清单：**
- [ ] 测试5个文件的导入
  - [ ] 涌益周度数据.xlsx
  - [ ] 涌益日度数据.xlsx
  - [ ] lh_ftr.xlsx
  - [ ] lh_opt.xlsx
  - [ ] 钢联自动更新模板.xlsx

- [ ] 验证数据完整性
  - [ ] 检查数据行数
  - [ ] 检查数据缺失
  - [ ] 检查数据重复

- [ ] 验证数据准确性
  - [ ] 抽样对比Excel原始数据
  - [ ] 检查数据格式转换
  - [ ] 检查数值精度

**交付物：**
- 数据导入测试报告
- 数据质量报告

#### 4.2 数据质量验证（0.5天）

**任务清单：**
- [ ] 检查数据重复
  - [ ] 检查dedup_key唯一性
  - [ ] 检查时间序列连续性

- [ ] 检查数据缺失
  - [ ] 检查必填字段缺失
  - [ ] 检查时间序列缺失

- [ ] 检查数据异常值
  - [ ] 检查数值范围
  - [ ] 检查数据格式
  - [ ] 检查逻辑一致性

**交付物：**
- 数据质量验证报告
- 数据问题清单

#### 4.3 性能优化（0.5-1天）

**任务清单：**
- [ ] 优化批量插入性能
  - [ ] 调整批量大小
  - [ ] 优化SQL语句
  - [ ] 优化事务处理

- [ ] 优化索引使用
  - [ ] 检查索引使用情况
  - [ ] 优化慢查询
  - [ ] 添加缺失索引

- [ ] 优化查询性能
  - [ ] 测试常用查询
  - [ ] 优化查询语句
  - [ ] 添加查询缓存（如需要）

**交付物：**
- 性能优化报告
- 性能测试结果

## 四、实施时间表

### 第1周：Phase 1 + Phase 2（数据模型 + 导入器）

**Day 1-2: Phase 1 - 数据模型完善**
- Day 1上午：检查现有模型
- Day 1下午：补充缺失功能
- Day 2上午：测试数据模型
- Day 2下午：Phase 2准备

**Day 3-5: Phase 2 - 导入器实现**
- Day 3：完善现有导入器（期货/期权/钢联/涌益日度）
- Day 4：扩展涌益周度导入器
- Day 5：实现新Parser

**Day 6-7: Phase 2继续**
- Day 6：实现标签写入逻辑 + 测试导入器
- Day 7：Phase 3准备

### 第2周：Phase 3 + Phase 4（配置 + 测试）

**Day 8-9: Phase 3 - 配置完善**
- Day 8：补充涌益周度配置（优先级1+2）
- Day 9：补充涌益周度配置（优先级3+4）+ 完善指标映射

**Day 10-11: Phase 4 - 测试与验证**
- Day 10：数据导入测试 + 数据质量验证
- Day 11：性能优化 + 总结报告

## 五、风险控制

### 5.1 技术风险

**风险1：复杂表头解析困难**
- **应对措施：**
  - 先处理简单格式，复杂格式后续处理
  - 使用配置驱动的解析器，便于扩展
  - 复杂格式先入raw_layer，后续逐步结构化

**风险2：数据量大导致性能问题**
- **应对措施：**
  - 分批导入（每批1000条）
  - 优化索引
  - 必要时使用分区表

**风险3：数据质量问题**
- **应对措施：**
  - 实现数据验证器
  - 记录错误日志
  - 允许部分失败，继续处理其他数据

### 5.2 进度风险

**风险1：工作量估算不准确**
- **应对措施：**
  - 每天跟踪进度
  - 及时调整计划
  - 优先完成核心功能

**风险2：依赖问题**
- **应对措施：**
  - 提前识别依赖
  - 并行开发（如可能）
  - 准备备选方案

## 六、验收标准

### 6.1 功能验收

- [ ] 5个文件可以成功导入
- [ ] 数据正确写入数据库
- [ ] 标签正确写入标签表
- [ ] 数据查询功能正常
- [ ] 错误处理机制完善

### 6.2 质量验收

- [ ] 数据完整性：>95%
- [ ] 数据准确性：>99%
- [ ] 代码覆盖率：>80%
- [ ] 性能指标：导入速度 > 1000条/秒

### 6.3 文档验收

- [ ] 技术文档完整
- [ ] 配置文档完整
- [ ] 测试报告完整
- [ ] 用户手册完整（如需要）

## 七、后续工作

### 7.1 派生计算功能（2-3天）

**任务清单：**
- [ ] 升贴水计算（C1）
- [ ] 月间价差计算（C2）
- [ ] 指标抽取到`fact_indicator_ts`（用于快速查询）

### 7.2 前端展示功能（3-5天）

**任务清单：**
- [ ] 核心看板开发
- [ ] 季节性图表
- [ ] 省区对比页面

### 7.3 数据源补充（待定）

**任务清单：**
- [ ] 获取集团企业统计数据
- [ ] 获取统计局数据
- [ ] 实现供需曲线数据导入

## 八、总结

本实施计划旨在完成5个Excel文件的入库工作，实现60-70%的核心业务数据覆盖。计划分为4个阶段，预计6-11天完成。通过分阶段实施、风险控制和验收标准，确保项目按时按质完成。
