# E4. 统计局数据汇总 需求对接完成总结

## 一、需求概述

完成E4. 统计局数据汇总功能，使用【生猪产业数据】.xlsx文件中的"03.统计局季度数据"sheet作为数据源。

## 二、数据源分析

### 2.1 Excel文件位置
- 文件路径：`docs/生猪/2、【生猪产业数据】.xlsx`
- Sheet名称：`03.统计局季度数据`

### 2.2 数据结构

**表头结构（2行）**：
- **第1行（主表头）**：
  - B列：季度
  - C列：能繁母猪
  - F列：生猪存栏
  - J列：生猪出栏
  - P列：定点屠宰
  - U列：猪肉产量
  - Z列：猪肉进口
  - AD列：猪肉供给（产量+进口）

- **第2行（子表头）**：
  - C列：存栏量
  - D列：环比
  - E列：同比
  - F列：存栏量
  - G列：商品猪
  - H列：环比
  - I列：同比
  - J列：出栏量
  - K列：比例
  - L列：环比
  - M列：同比
  - N列：累计
  - O列：同比
  - P列：屠宰量
  - Q列：同比
  - R列：累计
  - S列：同比
  - T列：占比
  - U列：产量
  - V列：同比
  - W列：累计
  - X列：同比
  - Y列：头均出肉

**数据行（第3行开始）**：
- B列：季度日期（格式：YYYY-MM-DD）
- C-Y列：各类统计数据

### 2.3 关键数据列

**表1：统计局季度数据汇总**
- 需要B-Y列的所有数据（24列）
- 合并主表头和子表头生成完整列名

**图1：统计局生猪出栏量&屠宰量**
- J列（索引9）：季度出栏量
- P列（索引15）：定点屠宰量
- 规模化率 = 屠宰量 / 出栏量

## 三、实现方案

### 3.1 API修改

**文件**：`backend/app/api/statistics_bureau.py`

**修改内容**：

1. **`get_quarterly_data`函数**：
   - 合并第1行和第2行的表头，生成完整的列名
   - 从第3行开始解析数据行
   - B列是季度日期，解析为YYYYQ格式（如2024Q1）
   - 提取B-Y列的所有数据

2. **`get_output_slaughter`函数**：
   - 从第3行开始解析数据
   - B列是季度日期，解析为YYYYQ格式
   - J列是季度出栏量
   - P列是定点屠宰量
   - 计算规模化率

### 3.2 数据解析逻辑

1. **表头合并**：
   - 遍历B-Y列（索引1-24）
   - 如果主表头和子表头都有值，合并为"主表头-子表头"
   - 如果只有主表头，使用主表头
   - 如果只有子表头，使用子表头
   - 如果都没有，使用列名（B, C, ..., Y）

2. **季度解析**：
   - B列是日期格式（如"2009-03-01T00:00:00"）
   - 解析日期后，根据月份计算季度：
     - Q1: 1-3月
     - Q2: 4-6月
     - Q3: 7-9月
     - Q4: 10-12月
   - 转换为YYYYQ格式（如"2024Q1"）

3. **数据提取**：
   - 从第3行开始遍历数据行
   - 提取B-Y列的所有数值数据
   - 过滤NaN和Inf值

### 3.3 数据验证

**测试结果**：
- ✓ 成功解析56个数据点
- ✓ 数据时间范围：2012Q1 至 2025Q4
- ✓ 表头合并正确：24个列名
- ✓ 出栏量和屠宰量数据正确

**示例数据**：
```
2012Q1: 出栏量=19989.0, 屠宰量=5270.6
2025Q4: 出栏量=18981.0, 屠宰量=12091.0
```

## 四、数据导入状态

### 4.1 导入检查

**检查脚本**：`backend/scripts/check_statistics_bureau_sheet.py`

**检查结果**：
- ✓ "03.统计局季度数据"sheet已导入到数据库
- ✓ Sheet ID: 800
- ✓ 文件ID: 81
- ✓ 文件名: 2、【生猪产业数据】.xlsx
- ✓ 数据行数: 125行

### 4.2 导入方式

如果数据未导入，可以运行：
```bash
python backend/scripts/import_industry_data.py
```

该脚本会导入整个【生猪产业数据】.xlsx文件的所有sheet，包括"03.统计局季度数据"sheet。

## 五、API接口

### 5.1 接口信息

#### 接口1：获取季度数据汇总
**端点**：`GET /api/v1/statistics-bureau/quarterly-data`

**响应模型**：`QuarterlyDataResponse`

**响应结构**：
```json
{
  "headers": [
    "季度",
    "能繁母猪-存栏量",
    "环比",
    "同比",
    "生猪存栏-存栏量",
    ...
  ],
  "data": [
    {
      "period": "2024Q1",
      "data": {
        "B": null,
        "C": 4100.0,
        "D": 0.02,
        ...
      }
    },
    ...
  ]
}
```

#### 接口2：获取出栏量&屠宰量
**端点**：`GET /api/v1/statistics-bureau/output-slaughter`

**响应模型**：`OutputSlaughterResponse`

**响应结构**：
```json
{
  "data": [
    {
      "period": "2024Q1",
      "output_volume": 19455.0,
      "slaughter_volume": 8329.0,
      "scale_rate": 0.428
    },
    ...
  ],
  "latest_period": "2025Q4"
}
```

### 5.2 数据字段说明

**季度数据汇总**：
- `headers`: 列名列表（B-Y列）
- `data`: 数据行列表
  - `period`: 季度（格式：YYYYQ）
  - `data`: 数据字典，键为列名（B-Y）

**出栏量&屠宰量**：
- `period`: 季度（格式：YYYYQ）
- `output_volume`: 季度出栏量（万头）
- `slaughter_volume`: 定点屠宰量（万头）
- `scale_rate`: 规模化率（屠宰量/出栏量）
- `latest_period`: 最新季度

## 六、前端对接

### 6.1 前端组件

**文件**：`frontend/src/views/official-data/StatisticsBureau.vue`

**功能**：
- 表1：统计局季度数据汇总（显示B-Y列的所有数据）
- 图1：统计局生猪出栏量&屠宰量（出栏量、屠宰量、规模化率）
- 图2：猪肉进口（月度进口量，分国别）

### 6.2 API调用

**文件**：`frontend/src/api/statistics-bureau.ts`

**接口**：
- `getQuarterlyData()` - 获取季度数据汇总
- `getOutputSlaughter()` - 获取出栏量&屠宰量
- `getImportMeat()` - 获取猪肉进口数据

前端已配置好API调用，数据会自动从新的数据源获取。

## 七、测试验证

### 7.1 测试脚本

**文件**：`backend/scripts/test_statistics_bureau_api.py`

**测试结果**：
- ✓ 数据解析成功
- ✓ 共56个数据点
- ✓ 数据时间范围正确
- ✓ 表头合并正确
- ✓ 出栏量和屠宰量数据正确

### 7.2 验证步骤

1. 运行测试脚本验证数据解析：
   ```bash
   python backend/scripts/test_statistics_bureau_api.py
   ```

2. 启动后端服务，测试API接口：
   ```bash
   curl http://localhost:8000/api/v1/statistics-bureau/quarterly-data
   curl http://localhost:8000/api/v1/statistics-bureau/output-slaughter
   ```

3. 在前端页面查看表格和图表显示是否正常

## 八、完成状态

### 8.1 已完成

- ✅ Excel文件结构分析
- ✅ 数据解析逻辑实现
- ✅ API接口修改
- ✅ 表头合并逻辑实现
- ✅ 季度日期解析实现
- ✅ 数据导入验证
- ✅ 测试脚本编写
- ✅ 数据解析测试通过

### 8.2 待验证

- ⏳ 前端页面显示验证
- ⏳ 完整数据流测试
- ⏳ 表格列名显示验证

## 九、相关文件

### 9.1 后端文件

- `backend/app/api/statistics_bureau.py` - API实现
- `backend/scripts/analyze_statistics_bureau_sheet.py` - Sheet结构分析脚本
- `backend/scripts/check_statistics_bureau_sheet.py` - 数据导入检查脚本
- `backend/scripts/test_statistics_bureau_api.py` - API测试脚本
- `backend/scripts/import_industry_data.py` - 数据导入脚本

### 9.2 前端文件

- `frontend/src/views/official-data/StatisticsBureau.vue` - 前端组件
- `frontend/src/api/statistics-bureau.ts` - API客户端

### 9.3 数据文件

- `docs/生猪/2、【生猪产业数据】.xlsx` - 数据源文件

## 十、注意事项

1. **数据更新**：如果Excel文件更新，需要重新运行导入脚本
2. **数据格式**：确保Excel文件中的"03.统计局季度数据"sheet格式保持一致
3. **日期格式**：B列的日期格式需要是标准日期格式（YYYY-MM-DD）
4. **表头合并**：主表头和子表头会自动合并，如果格式变化可能需要调整合并逻辑
5. **季度计算**：季度根据月份自动计算，Q1=1-3月，Q2=4-6月，Q3=7-9月，Q4=10-12月

## 十一、后续优化建议

1. **数据缓存**：可以考虑添加Redis缓存，提高查询性能
2. **数据验证**：添加更严格的数据验证，确保数据质量
3. **错误处理**：完善错误处理机制，提供更友好的错误信息
4. **数据监控**：添加数据更新监控，及时发现数据问题
5. **性能优化**：如果数据量很大，可以考虑分页或限制查询范围
6. **表头优化**：可以考虑优化表头显示，使其更易读
