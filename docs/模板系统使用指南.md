# 模板系统使用指南

## ✅ 已完成的工作

### 1. 8套预设模板已创建并入库

所有8套模板已成功初始化到数据库，可以通过以下方式验证：

```bash
cd backend
python verify_templates.py
```

### 2. 指标代码映射已优化

根据实际数据库中的110个指标，已优化映射规则：

- ✅ `HOG_PRICE_NATIONAL` -> ID 1 (商品猪：出栏均价：中国（日）)
- ✅ `SPREAD_STANDARD_FATTY` -> ID 78 (生猪标肥：价差：中国（日）)
- ✅ `SPREAD_MAO_BAI` -> ID 92 (毛白：价差：中国（日）)
- ✅ `PRICE_BY_PROVINCE` -> ID 2 (商品猪：出栏均价：黑龙江（日）)
- ✅ `PRICE_BY_GROUP` -> ID 21 (外三元猪：每头重110-125kg：出栏价：辽宁：辽宁大北农（日）)
- ✅ `PROFIT_PURCHASE_PIGLET` -> ID 110 (猪：外购利润（周）)

### 3. 前端功能已修复

- ✅ ChartBuilder页面：模板加载和保存功能已实现
- ✅ TemplateCenter页面：新增模板中心页面，展示8套预设模板
- ✅ 支持从模板中心选择模板并配置参数

## 📋 模板列表

| ID | 名称 | 类别 | 图表类型 | 用途 |
|---|---|---|---|---|
| T01 | 标肥价差季节性 | 价差 | seasonality | 每周判断标肥价差处于历史什么位置 |
| T02 | 毛白价差季节性 | 价差 | seasonality | 用于屠宰/白条环节分析 |
| T03 | 生猪价格季节性 | 价格 | seasonality | 看猪价季节性（管理层/研究必备） |
| T04 | 价格+标肥价差（区间双轴） | 复盘 | timeseries | 复盘某段时间内价格与价差联动 |
| T05 | 区域价差季节性 | 价差 | seasonality | 判断区域结构变化（南北/东西） |
| T06 | 分省价格对比 | 区域 | timeseries | 周报里经常要重点省份排名/分化 |
| T07 | 集团企业价格对比 | 企业 | timeseries | 企业专题（Top5/Top10企业价格对比） |
| T08 | 周报核心包 | 管理看板 | composite | 一键生成报告包（4-6张图一次性生成） |

## 🚀 使用方法

### 方式1：通过模板中心页面（推荐）

1. 访问 `/template-center` 页面
2. 浏览8套预设模板，按类别筛选
3. 点击"使用模板"按钮
4. 配置参数（年份、日期范围、地区等）
5. 点击"应用并生成"
6. 系统自动跳转到ChartBuilder页面并生成图表

### 方式2：通过ChartBuilder页面

1. 访问 `/chart-builder` 页面
2. 点击"从模板加载"按钮
3. 选择已保存的模板（用户自定义模板）
4. 系统自动填充配置
5. 点击"生成图表"查看结果

### 方式3：保存当前配置为模板

1. 在ChartBuilder页面配置好图表参数
2. 点击"保存为模板"按钮
3. 输入模板名称
4. 模板保存到数据库，可在"模板管理"页面查看

## 🔧 技术实现

### 后端

- **模板配置**：`backend/app/data/templates.json`
- **指标映射**：`backend/app/models/metric_code_map.py`
- **模板服务**：`backend/app/services/template_service.py`
- **模板执行**：`backend/app/services/template_executor.py`
- **API端点**：
  - `GET /api/v1/templates/preset` - 获取8套预设模板
  - `POST /api/v1/templates/init-preset` - 初始化模板到数据库（仅admin）

### 前端

- **模板中心**：`frontend/src/views/TemplateCenter.vue`
- **模板管理**：`frontend/src/views/Templates.vue`
- **图表配置**：`frontend/src/views/ChartBuilder.vue`
- **API客户端**：`frontend/src/api/templates.ts`

## 📝 注意事项

1. **预设模板 vs 用户模板**：
   - 预设模板（T01-T08）：存储在JSON文件中，通过API获取
   - 用户模板：存储在数据库`chart_template`表中

2. **指标映射**：
   - 模板中使用`metric_code`占位符（如`SPREAD_STANDARD_FATTY`）
   - 系统自动通过关键词匹配映射到实际的`metric_id`
   - 如果匹配失败，会使用该指标组的第一个指标作为默认值

3. **参数占位符**：
   - 模板中使用`{{params.years}}`等占位符
   - 执行时会替换为用户提供的实际参数值

## 🧪 测试建议

1. **测试模板加载**：
   - 访问模板中心，选择T01模板
   - 配置年份为最近3年
   - 验证是否能正确生成季节性图

2. **测试模板保存**：
   - 在ChartBuilder配置一个季节性图
   - 保存为模板
   - 在模板管理页面验证是否出现

3. **测试指标映射**：
   - 运行`python test_template_mapping.py`
   - 验证所有占位符都能正确映射到指标ID

## 🔄 后续优化建议

1. **模板执行API**：创建`POST /api/v1/templates/{template_id}/execute`端点，直接执行模板并返回数据
2. **模板预览**：在模板中心显示模板的预览图或示例数据
3. **模板收藏**：允许用户收藏常用模板
4. **模板分享**：支持模板链接分享功能
