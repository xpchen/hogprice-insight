# 钢联数据导入逻辑说明

## 数据格式识别

钢联数据格式特征：
- 第1行：标题（"钢联数据"）
- 第2行：指标名称行（包含完整的指标名称，如"商品猪：出栏均价：中国（日）"）
- 第3行：单位行
- 第4行：更新时间行
- 第5行开始：数据行（日期在第一列，数据在后续列）

## 导入流程

### 1. 模板检测
- 检测到第1行第1列为"钢联数据" → 识别为 `GANGLIAN_DAILY`
- 数据源代码设置为 `GANGLIAN`（与涌益数据区分）

### 2. Sheet处理
- 遍历所有sheet
- 每个sheet独立处理，处理完后立即提交事务
- 即使某个sheet失败，也会继续处理其他sheet

### 3. 指标解析
从指标名称中提取信息：
- **格式**：`商品猪：出栏均价：中国（日）`
  - 第一部分：商品类型（如"商品猪"）
  - 第二部分：指标类型（如"出栏均价"）
  - 第三部分：区域（如"中国"）+ 频率（如"（日）"）

**区域解析**：
- 提取第三部分，移除括号内容
- 标准化区域名称（如"黑龙江" → "HEILONGJIANG"）
- 自动创建区域维度记录

**指标代码推断**：
- `出栏均价`/`出栏价` + `NATION` → `hog_price_nation`
- `出栏均价`/`出栏价` + 省份 → `hog_price_province`
- `价差` + `标肥` → `spread_std_fat`
- `价差` + `区域` → `spread_region`
- `利润` → `profit_breeding`

### 4. 数据处理
- **日期解析**：支持多种日期格式（`YYYY-MM-DD HH:MM:SS`等）
- **数值清洗**：处理 `#N/A`、空值、千分位逗号等
- **数据验证**：日期范围检查（2000-2100年）

### 5. 数据插入
- **分批插入**：每批1000条记录，避免锁超时
- **更新策略**：如果记录已存在（相同指标+区域+日期），则更新值
- **事务管理**：每个sheet处理完后立即提交

## 性能优化

1. **分批处理**：每批1000条记录
2. **及时提交**：每个sheet处理完后立即提交，避免长事务
3. **错误隔离**：单个sheet失败不影响其他sheet
4. **内存管理**：每批flush，避免内存占用过大

## 错误处理

- **数据库锁超时**：通过分批提交和及时提交避免
- **数据格式错误**：记录错误但继续处理
- **事务回滚**：单个sheet失败时回滚，不影响其他sheet

## 数据源代码区分

- **钢联数据**：`source_code="GANGLIAN"`
- **涌益数据**：`source_code="YONGYI"`
- **期货/期权**：`source_code="DCE"`

这样可以：
1. 区分不同数据源
2. 支持数据溯源
3. 支持按数据源查询和统计
