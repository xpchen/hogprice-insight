# 价格展示功能数据提取记录

## 一、功能需求

价格展示功能包含4个图表：

1. **全国猪价（季节性）** - 数据来源：钢联"分省区猪价"sheet的"中国"列
2. **标肥价差（季节性）** - 数据来源：钢联"肥标价差"sheet
3. **猪价&标肥价差（可年度筛选）** - 数据来源：钢联（同上）
4. **日度屠宰量（农历）** - 数据来源：涌益咨询日度数据"价格+宰量"sheet

## 二、数据提取脚本

### 2.1 脚本位置

`backend/scripts/extract_ganglian_price_data.py`

### 2.2 功能说明

该脚本从Excel文件中提取价格相关数据并插入到MySQL数据库的`fact_observation`表中。

### 2.3 提取的数据

#### 2.3.1 全国猪价

- **来源文件**: `docs/1、价格：钢联自动更新模板.xlsx`
- **Sheet**: `分省区猪价`
- **列**: "商品猪：出栏均价：中国（日）"
- **指标键**: `GL_D_PRICE_NATION`
- **指标名称**: `全国出栏均价`
- **单位**: `元/公斤`
- **存储表**: `fact_observation`
- **标签**: `{"scope": "nation", "source": "GANGLIAN"}`

#### 2.3.2 标肥价差

- **来源文件**: `docs/1、价格：钢联自动更新模板.xlsx`
- **Sheet**: `肥标价差`
- **列**: 所有列（分省区）
- **指标键**: `GL_D_FAT_STD_SPREAD`
- **指标名称**: `标肥价差`
- **单位**: `元/公斤`
- **存储表**: `fact_observation`
- **标签**: `{"region": "<region_code>", "source": "GANGLIAN"}`

#### 2.3.3 日度屠宰量

- **来源文件**: `docs/2026年2月2日涌益咨询日度数据.xlsx`
- **Sheet**: `价格+宰量`
- **列**: "日屠宰量合计1"或"日度屠宰量合计2"
- **指标键**: `YY_D_SLAUGHTER_TOTAL`
- **指标名称**: `日度屠宰量`
- **单位**: `头`
- **存储表**: `fact_observation`
- **标签**: `{"scope": "nation", "source": "YONGYI"}`

### 2.4 运行方式

```bash
cd backend
python scripts/extract_ganglian_price_data.py
```

### 2.5 提取日志

提取完成后，会在`docs/ganglian_price_extraction_log.json`中记录提取过程，包括：

- 提取日期
- 源文件路径
- 批次ID
- 各指标提取结果（插入记录数、日期范围等）
- 总计插入记录数

## 三、API接口

### 3.1 接口位置

`backend/app/api/price_display.py`

### 3.2 接口列表

#### 3.2.1 获取全国猪价季节性数据

```
GET /api/v1/price-display/national-price/seasonality
```

**参数**:
- `start_year` (可选): 起始年份
- `end_year` (可选): 结束年份

**响应**: `SeasonalityResponse`

#### 3.2.2 获取标肥价差季节性数据

```
GET /api/v1/price-display/fat-std-spread/seasonality
```

**参数**:
- `start_year` (可选): 起始年份
- `end_year` (可选): 结束年份
- `region_code` (可选): 区域代码（默认全国）

**响应**: `SeasonalityResponse`

#### 3.2.3 获取猪价和标肥价差数据（可年度筛选）

```
GET /api/v1/price-display/price-and-spread
```

**参数**:
- `selected_years` (可选): 选中的年份，逗号分隔，如'2021,2022,2023'

**响应**: `PriceSpreadResponse`

#### 3.2.4 获取日度屠宰量（农历）数据

```
GET /api/v1/price-display/slaughter/lunar
```

**参数**:
- `start_year` (可选): 起始年份
- `end_year` (可选): 结束年份

**响应**: `SlaughterLunarResponse`

#### 3.2.5 获取价格/价差涨跌数据

```
GET /api/v1/price-display/price-changes
```

**参数**:
- `metric_type`: 指标类型，`price`（价格）或`spread`（价差）

**响应**: `PriceChangesResponse`

包含：
- `current_value`: 当前值
- `latest_date`: 最新日期
- `day5_change`: 5日涨跌
- `day10_change`: 10日涨跌
- `day30_change`: 30日涨跌
- `yoy_change`: 同比涨跌
- `unit`: 单位

## 四、前端页面

### 4.1 页面位置

`frontend/src/views/national-data/Price.vue`

### 4.2 功能说明

页面展示4个图表：

1. **全国猪价（季节性）** - 使用ECharts绘制多年度季节性曲线
2. **标肥价差（季节性）** - 使用ECharts绘制多年度季节性曲线
3. **猪价&标肥价差（可年度筛选）** - 支持通过复选框筛选年份，双Y轴展示价格和价差
4. **日度屠宰量（农历）** - 季节性图表（当前使用阳历日期，后续需要实现农历对齐）

### 4.3 图表特性

- **年度筛选**: 图表3支持通过复选框筛选显示的年份
- **涨跌注释**: 图表1和2下方显示5日/10日/30日涨跌幅和同比涨跌幅
- **更新时间**: 显示数据最新更新时间
- **数据来源标注**: 每个图表标题标注数据来源

## 五、数据流程

```
Excel文件
  ↓
数据提取脚本 (extract_ganglian_price_data.py)
  ↓
fact_observation表
  ↓
API接口 (price_display.py)
  ↓
前端页面 (Price.vue)
```

## 六、后续工作

1. **农历对齐**: 实现日度屠宰量数据的农历对齐（正月初八到腊月二十八）
2. **闰月处理**: 单独显示闰月数据
3. **数据导入**: 将提取脚本集成到统一的数据导入流程中
4. **数据更新**: 支持增量更新数据

## 七、注意事项

1. **指标查询**: API通过`DimMetric`表查询指标，如果指标不存在，需要先运行数据提取脚本
2. **数据格式**: 确保Excel文件格式符合预期（钢联标准格式）
3. **去重键**: 使用`dedup_key`进行数据去重，避免重复插入
4. **标签存储**: 区域信息存储在`tags_json`字段中，查询时通过JSON字段筛选

## 八、相关文件

- 数据提取脚本: `backend/scripts/extract_ganglian_price_data.py`
- API接口: `backend/app/api/price_display.py`
- 前端页面: `frontend/src/views/national-data/Price.vue`
- API客户端: `frontend/src/api/price-display.ts`
- 提取日志: `docs/ganglian_price_extraction_log.json`
