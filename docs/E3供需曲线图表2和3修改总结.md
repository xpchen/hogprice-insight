# E3. 供需曲线 - 图表2和图表3修改总结

## 一、修改概述

修改E3. 供需曲线的图表2和图表3，使其从NYB sheet读取数据，并按照农业部的环比累计计算指数。

## 二、数据源

### 2.1 数据文件
- 文件路径：`docs/生猪/2、【生猪产业数据】.xlsx`
- Sheet名称：`NYB`

### 2.2 数据结构

**NYB sheet结构**：
- 第1行（索引0）：主表头（C列是"能繁环比"，G列是"新生仔猪环比"）
- 第2行（索引1）：子表头（B列是"月度"，C列是"全国"，G列是"全国"）
- 第3行（索引2）开始：数据行
  - B列（索引1）：日期
  - C列（索引2）：能繁母猪环比-全国
  - G列（索引6）：新生仔猪环比-全国

### 2.3 数据格式

**C列（能繁母猪环比）**：
- 值是环比比例（本月/上月）
- 如1.2表示本月是上月的1.2倍（环比增长20%）
- 如5.0表示本月是上月的5.0倍（环比增长400%）

**G列（新生仔猪环比）**：
- 正数：直接是比例（如3.4表示本月/上月=3.4）
- 负数：需要转换为比例（如-0.8表示本月/上月=1-0.8=0.2）

## 三、实现方案

### 3.1 图表2：能繁母猪存栏&猪价（滞后10个月）

**数据来源**：
- 能繁母猪存栏指数：NYB sheet的C列
- 猪价：钢联全国猪价（滞后10个月）

**计算逻辑**：
1. 从NYB sheet提取C列数据（从第3行开始）
2. 以2020年1月为基准，指数=80
3. 按照环比累计计算：
   - 当前指数 = 上月指数 × 环比比例
4. 获取猪价数据（滞后10个月）

### 3.2 图表3：新生仔猪&猪价（滞后10个月）

**数据来源**：
- 新生仔猪指数：NYB sheet的G列
- 猪价：钢联全国猪价（滞后10个月）

**计算逻辑**：
1. 从NYB sheet提取G列数据（从第3行开始）
2. 以2020年1月为基准，指数=80
3. 按照环比累计计算：
   - 如果环比值是负数，转换为比例：mom = 1 + mom
   - 如果环比值是正数，直接使用
   - 当前指数 = 上月指数 × 环比比例
4. 获取猪价数据（滞后10个月）

## 四、代码修改

### 4.1 API修改

**文件**：`backend/app/api/supply_demand.py`

**修改内容**：

1. **`get_breeding_inventory_price`函数**：
   - 修改数据提取逻辑：从第3行开始（跳过第1行和第2行表头）
   - 修改日期列：使用B列（索引1）而不是A列（索引0）
   - 修改数据列：使用C列（索引2）
   - 修改指数计算：直接使用C列的值作为环比比例进行累计计算

2. **`get_piglet_price`函数**：
   - 修改数据提取逻辑：从第3行开始（跳过第1行和第2行表头）
   - 修改日期列：使用B列（索引1）而不是A列（索引0）
   - 修改数据列：使用G列（索引6）
   - 修改指数计算：处理负数环比值，转换为比例后累计计算

## 五、数据验证

### 5.1 测试结果

**能繁母猪数据**：
- ✓ 成功提取72条数据
- ✓ 时间范围：2020-01 至 2025-12
- ✓ 2020年1月数据：C列=1.2

**新生仔猪数据**：
- ✓ 成功提取69条数据
- ✓ 时间范围：2020-01 至 2025-09
- ✓ 2020年1月数据：G列=-0.8（转换为0.2）

### 5.2 指数计算示例

**能繁母猪指数**：
- 2020-01: 指数=80.0, 环比=1.2
- 2020-02: 指数=96.0（如果1.2是比例）或136.0（如果1.7是比例）

**新生仔猪指数**：
- 2020-01: 指数=80.0, 环比=-0.8（转换为0.2）
- 2020-02: 指数=16.0（如果0.2是比例）或272.0（如果3.4是比例）

## 六、注意事项

1. **数据格式**：C列和G列的值是环比比例，直接用于累计计算
2. **负数处理**：G列的负数需要转换为比例（mom = 1 + mom）
3. **基准点**：以2020年1月为80，这是固定的基准点
4. **滞后计算**：猪价数据需要滞后10个月（约300天）
5. **数据过滤**：过滤掉mom <= 0的异常值

## 七、相关文件

### 7.1 后端文件

- `backend/app/api/supply_demand.py` - API实现
- `backend/scripts/check_nyb_sheet_structure.py` - NYB sheet结构检查脚本
- `backend/scripts/test_nyb_index_calculation.py` - 指数计算测试脚本
- `backend/scripts/check_nyb_data_format.py` - 数据格式检查脚本

### 7.2 前端文件

- `frontend/src/views/official-data/SupplyDemandCurve.vue` - 前端组件
- `frontend/src/api/supply-demand.ts` - API客户端

### 7.3 数据文件

- `docs/生猪/2、【生猪产业数据】.xlsx` - 数据源文件（NYB sheet）

## 八、完成状态

### 8.1 已完成

- ✅ NYB sheet数据结构分析
- ✅ 数据提取逻辑修改（B列日期，C列能繁，G列新生仔猪）
- ✅ 指数计算逻辑实现（环比累计计算）
- ✅ 负数环比值处理（G列）
- ✅ 代码修改完成

### 8.2 待验证

- ⏳ 前端页面显示验证
- ⏳ 完整数据流测试
- ⏳ 指数计算结果的合理性验证
