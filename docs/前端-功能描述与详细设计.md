# 前端功能描述与详细设计（基于现有 frontend.zip）

> 目标：在不大改架构的前提下，把现有“查询 + 图表”前端升级为：**模板复用、完成度看板、TopN摘要、报告中心**。  
> 技术栈：Vue3 + Vite + TypeScript + Element Plus（以当前工程为准）。

---

## 1. 当前前端已具备能力（代码现状梳理）

### 1.1 已有 API 封装（src/api）
- `auth.ts`：login/me
- `import.ts`：excel 导入
- `metadata.ts`：指标/维度元数据
- `query.ts`：timeseries / seasonality 查询
- `export.ts`：导出相关
- `request.ts`：axios 封装（拦截器/Token）

### 1.2 已有组件（src/components）
- `FilterPanel.vue`：指标/维度/日期等筛选面板
- `SeasonalityChart.vue`：季节性叠线图
- `ChartPanel.vue`：通用图表面板（区间折线/表格等）

### 1.3 已有页面（src/views）
- `Dashboard.vue`：基础首页（当前偏轻）
- `Import.vue`：导入页（批次导入）
- `Analysis.vue`：分析页（筛选 + timeseries/seasonality 渲染 + 导出）
- `ChartBuilder.vue`：图表构建（偏模板雏形）

---

## 2. 页面信息架构（一期增强后）

- Dashboard（数据更新概览 + 常用模板 + TopN）
- Analysis（通用分析：季节性/区间图）
- Templates（模板管理：我的/公共）
- Import（导入与批次）
- Reports（报告中心：模板列表 + 生成记录）
- Admin（用户/权限，若已有可复用）

> 路由建议：在现有基础上增 2-3 个 view，尽量复用 `FilterPanel/ChartPanel/SeasonalityChart`。

---

## 3. 核心交互设计（面向客户工作流）

### 3.1 季节性分析（主路径）
用户流程：
1) 选择指标（单选）+ 年份（多选）
2) 选择维度（地区/企业/交割库）与 tags
3) 点击查询 → 出图（每年一条线）+ 下方宽表（可选）
4) 一键导出（Excel）

交互要点：
- 指标选择器支持搜索、按 metric_group 分类
- 年份多选默认给最近 6 年
- x_mode 默认 week_of_year（高级开关允许 month_day）
- tooltip 支持同周多年的对比

### 3.2 区间对比（辅路径）
用户流程：
1) 选择日期区间
2) 选择指标 1~2 个（默认 2）
3) 自动双轴（单位不同）+ 可手动切换
4) 导出（Excel）

交互要点：
- 指标数量限制：一期建议最多 2（UI 更清晰）
- time_dimension 默认 daily，可切 weekly/monthly（对性能友好）
- 可选开关：MA7/MA14（如果后端不做，前端也能做，但建议后端统一）

---

## 4. 新增功能详细设计

### 4.1 图表模板（P0）
#### 4.1.1 UI 功能点
- 在 Analysis/ChartBuilder 中新增按钮：
  - “保存为模板”
  - “从模板加载”
- 新增 Templates 页面：
  - Tab：我的模板 / 公共模板
  - 操作：打开、复制、重命名、删除
  - admin 额外：发布公共/取消公共

#### 4.1.2 数据结构（前端侧）
- `ChartSpec`（与后端一致，见后端文档第 5 节）
- 模板列表项：
  - id/name/chart_type/is_public/updated_at

#### 4.1.3 状态管理建议
- 若当前项目未引入 pinia：可在 `src/store/` 轻量引入 pinia（推荐）
- 最少：在 `Analysis.vue` 中以 `reactive(spec)` 管理，保存时直接提交 spec_json

#### 4.1.4 验收
- 保存模板 → Dashboard 卡片可见 → 点击即复现图表

---

### 4.2 数据更新完成度（P0）
#### 4.2.1 Dashboard 卡片
- “整体最新日期”
- “未更新指标数”
- “缺口 Top10 指标”
- 按 metric_group 的完成率条形（可选）

#### 4.2.2 Completeness 表格页（可选）
- 支持搜索指标名、按 group 筛选
- 点击某指标跳转到 Analysis（自动带上 metric_id）

#### 4.2.3 验收
- 能在 10 秒内回答“今天哪些指标没更新到最新”

---

### 4.3 TopN/异常摘要（P1）
#### 4.3.1 Dashboard Top5
- 三个默认榜单（可配置）：
  - 价格涨跌 Top5（window=7）
  - 标肥价差变化 Top5（window=7）
  - 利润转负 Top5（若存在利润指标）

#### 4.3.2 Analysis 侧边摘要
- 查询完图后，同参数自动请求 topn
- 展示：最新值、变化、分位偏离（若后端返回）

#### 4.3.3 验收
- 一张图旁边能自动给出“本周异常点 Top5”，减少口头描述成本

---

### 4.4 报告中心（P1）
#### 4.4.1 Reports 页面
- 报告模板列表（周报-价差观察、周报-价格与利润…）
- 选择参数（年份/区间/地区等）
- 生成记录（run_id、状态、下载按钮）

#### 4.4.2 导出与下载
- 后端返回 output_url（或相对路径）
- 前端提供“下载”与“复制链接”

#### 4.4.3 验收
- 选择模板 → 生成 → 下载打开（Excel/zip）

---

## 5. 组件与复用设计（减少重复开发）

### 5.1 FilterPanel 升级点
- 支持两种模式：
  - seasonality：metric 单选 + years 多选 + x_mode
  - timeseries：metric 多选 + date_range + time_dimension
- tags_filter 区域：
  - 动态渲染 tag 键（由后端 `GET /dim/tags` 提供）
  - 常用 tag（pig_type/weight_range）优先展示

### 5.2 ChartPanel/SeasonalityChart 规范化输出
- 所有图表组件都输出：
  - `currentSpec`（可保存模板）
  - `download()`（触发导出）
  - `getSummary()`（触发 topn/摘要）

---

## 6. 路由与权限
- 路由 meta 标记 `requiresAuth`
- admin-only 页面/按钮按 `user.roles` 控制展示
- request 拦截器处理 401：跳转登录

---

## 7. 前后端契约（关键字段对齐）
- 所有查询返回必须包含 `meta.unit`、`meta.freq`、`meta.metric_name`
- seasonality：`x_values` 与 `series.values` 长度一致，缺失用 null
- timeseries：`x` 为 ISO date string；series 每条含 name + values
- export：返回 `file_url`（或直接下载流）

---

## 8. 验收用例（前端侧）
1) 新建 seasonality 图 → 保存模板 → Dashboard 打开复现一致
2) Dashboard completeness：能看到未更新指标数与 Top10
3) Analysis：区间双指标图单位不同自动双轴
4) Reports：选择周报模板生成并下载成功

