# 区域价差功能说明

## 一、功能概述

区域价差功能（1.5）用于展示不同区域之间的价格差异，数据来源于钢联"区域价差"sheet表。

**标题格式**：（区域价差：XX-YY）

**注释**：5日涨跌，10日涨跌

## 二、数据提取

### 2.1 数据来源

- **文件**：`docs/1、价格：钢联自动更新模板.xlsx`
- **Sheet**：`区域价差`
- **数据格式**：列名格式为"商品猪：出栏均价：XX（日） - 商品猪：出栏均价：YY（日）"

### 2.2 提取脚本

#### 2.2.1 独立运行脚本（推荐）

**脚本位置**：`backend/scripts/extract_region_spread.py`

**运行方式**：
```bash
cd backend
python scripts/extract_region_spread.py
```

或者使用批处理文件：
```bash
backend\scripts\extract_region_spread.bat
```

#### 2.2.2 集成在主脚本中

区域价差提取功能也已集成到主提取脚本中：
- **脚本位置**：`backend/scripts/extract_ganglian_price_data.py`
- 运行主脚本时会同时提取区域价差数据

### 2.3 数据存储

- **表**：`fact_observation`
- **指标名称格式**：`区域价差：XX-YY`（例如：`区域价差：广东-广西`）
- **指标键格式**：`GL_D_REGION_SPREAD_{region1}_{region2}`
- **标签**：
  - `region_pair`: 区域对（如"广东-广西"）
  - `region1`: 第一个区域
  - `region2`: 第二个区域
  - `source`: "GANGLIAN"

### 2.4 提取日志

提取完成后，会在`docs/region_spread_extraction_log.json`中记录提取过程，包括：
- 提取日期
- 源文件路径
- 批次ID
- 各区域对提取结果（插入记录数、日期范围等）
- 总计插入记录数

## 三、API接口

### 3.1 获取区域价差季节性数据

**接口**：`GET /api/v1/price-display/region-spread/seasonality`

**参数**：
- `region_pair` (必需): 区域对，格式：XX-YY，如'广东-广西'
- `start_year` (可选): 起始年份
- `end_year` (可选): 结束年份

**响应**：`SeasonalityResponse`
- `metric_name`: 指标名称（格式：区域价差：XX-YY）
- `unit`: 单位（元/公斤）
- `series`: 季节性数据系列（按年份分组）
- `update_time`: 更新时间
- `latest_date`: 最新数据日期

**示例**：
```bash
GET /api/v1/price-display/region-spread/seasonality?region_pair=广东-广西&start_year=2021&end_year=2024
```

### 3.2 获取区域价差涨跌数据

**接口**：`GET /api/v1/price-display/region-spread/changes`

**参数**：
- `region_pair` (必需): 区域对，格式：XX-YY，如'广东-广西'

**响应**：
```json
{
  "current_value": 1.5,        // 当前值
  "latest_date": "2026-02-02", // 最新日期
  "day5_change": 0.2,          // 5日涨跌
  "day10_change": 0.3,         // 10日涨跌
  "unit": "元/公斤"            // 单位
}
```

**示例**：
```bash
GET /api/v1/price-display/region-spread/changes?region_pair=广东-广西
```

## 四、支持的区域对

根据钢联Excel文件，支持的区域对包括：

1. 广东-广西
2. 广东-四川
3. 广东-重庆
4. 广东-贵州
5. 广东-江西
6. 广东-湖南
7. 广东-河南
8. 四川-山西
9. 四川-陕西
10. 四川-山东
11. 四川-河南
12. 浙江-河南
13. 浙江-江西

（实际区域对以Excel文件中的列名为准）

## 五、使用示例

### 5.1 数据入库

```bash
# 单独运行区域价差入库
cd backend
python scripts/extract_region_spread.py
```

### 5.2 API调用示例

```python
import requests

# 获取区域价差季节性数据
response = requests.get(
    "http://localhost:8000/api/v1/price-display/region-spread/seasonality",
    params={
        "region_pair": "广东-广西",
        "start_year": 2021,
        "end_year": 2024
    },
    headers={"Authorization": "Bearer <token>"}
)
data = response.json()

# 获取区域价差涨跌数据
response = requests.get(
    "http://localhost:8000/api/v1/price-display/region-spread/changes",
    params={"region_pair": "广东-广西"},
    headers={"Authorization": "Bearer <token>"}
)
changes = response.json()
print(f"5日涨跌: {changes['day5_change']}")
print(f"10日涨跌: {changes['day10_change']}")
```

## 六、注意事项

1. **单独运行入库**：区域价差功能支持单独运行入库，不影响其他数据提取
2. **标题格式**：指标名称严格按照"区域价差：XX-YY"格式
3. **注释功能**：5日涨跌、10日涨跌通过`/region-spread/changes`接口获取
4. **数据更新**：每次运行提取脚本会更新已有数据，新增数据会插入新记录
5. **去重机制**：使用`dedup_key`确保同一天同一区域对的数据不会重复

## 七、参照功能

本功能参照1.4标肥价差功能实现，包括：
- 数据提取逻辑
- API接口设计
- 涨跌计算方式
- 季节性数据展示
