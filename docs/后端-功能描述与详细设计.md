# 后端功能描述与详细设计（基于现有 backend.zip）

> 目标：在**仅有“钢联自动更新模板.xlsx”**这一份数据源的前提下，把系统从“能导入/能画图”升级为“可复用、可交付、可运营”的研究工作台。  
> 技术栈假设：FastAPI + SQLAlchemy + Alembic + MySQL/SQLite（以你当前工程为准）。

---

## 1. 当前后端已具备能力（代码现状梳理）

### 1.1 已有路由（app/api）
- `POST /api/v1/auth/login`、`GET /api/v1/auth/me`：登录与用户信息（JWT）
- `POST /api/v1/import/excel`：Excel 导入（批次化）
- `GET /api/v1/metadata/*`：指标/地区/企业/交割库元数据
- `POST /api/v1/query/timeseries`：时间序列查询（支持 time_dimension 聚合）
- `POST /api/v1/query/seasonality`：季节性叠线（week_of_year / month_day）
- `POST /api/v1/export/*`：导出 Excel（当前已实现基础导出）

### 1.2 已有核心服务（app/services）
- `excel_import_service.py`：解析 Excel、写入 `FactObservation`，并维护 `DimMetric/DimGeo/DimCompany/DimWarehouse`
- `query_service.py`：时间序列查询 + filters/tags_filter + group_by + 聚合
- `seasonality_service.py`：季节性数据对齐输出（x_values + 多年 series）

### 1.3 已有数据模型（app/models）
- 事实表：`FactObservation`（长表：metric_id + obs_date + value + 维度 + tags_json）
- 维度表：`DimMetric/DimGeo/DimCompany/DimWarehouse`
- 批次表：`ImportBatch`
- 用户/角色：`sys_user/sys_role/sys_user_role`

---

## 2. 面向客户场景的一期增强范围（只依赖这一份 Excel）

### 2.1 P0：图表模板（保存/复用/共享）
**用户价值**：研究员每天反复“选指标、选年份、选地区”很浪费时间。模板化后可以一键复现常用图。

**后端要交付**
- 模板 CRUD API（个人模板 + 公共模板）
- 模板 spec 结构（ChartSpec）标准化与版本化
- 权限：公共模板仅 admin 可发布；个人模板仅本人可见

### 2.2 P0：数据更新完成表（Completeness）
**用户价值**：客户有“日度数据完成表”习惯，必须能看到“哪些指标没更新到最新”。

**后端要交付**
- 指标维度的 completeness 汇总：latest_date、缺失天数、连续性、覆盖率
- 指标组汇总：按 metric_group 聚合完成率
- Dashboard 一屏可读

### 2.3 P1：TopN/异常摘要（描述型，不依赖多源）
**用户价值**：客户周会/日会最常看 Top5：涨跌、价差变化、偏离季节性。

**后端要交付**
- `topn` 查询：支持按 geo/company/warehouse 维度输出 TopN
- 异常定义（可配置但先内置）：N 日变化、N 日百分比变化、分位偏离、连续涨跌天数

### 2.4 P1：报告包导出（先 Excel 包，后续再 PPTX）
**用户价值**：研究交付物优先是“可发出去的文件”。先实现“报告包”（zip 或多 sheet excel）。

**后端要交付**
- 报告模板（ReportTemplate）+ 报告实例（ReportRun）基本数据结构
- 一键生成：按模板配置批量跑 seasonality/timeseries，生成多 sheet excel 或 zip

---

## 3. 数据模型扩展（DDL & Alembic 迁移点）

> 以下为“建议增加”的表/字段；命名与你现有风格保持一致。

### 3.1 新增：`chart_template`（图表模板）
字段建议：
- `id` bigint pk
- `name` varchar(100)
- `chart_type` enum('seasonality','timeseries')
- `spec_json` json（ChartSpec）
- `owner_user_id` bigint（外键 sys_user）
- `is_public` tinyint(1) default 0
- `created_at/updated_at`
索引：
- `(owner_user_id, is_public)`
- `name`（可选）

### 3.2 新增：`report_template`、`report_run`
- `report_template`
  - `id, name, template_json, is_public, owner_user_id, created_at`
- `report_run`
  - `id, template_id, params_json, status, output_path, created_at, finished_at, error_json`

### 3.3 事实表去重建议（如尚未落地）
如果当前仍存在“重复导入导致膨胀”的风险，建议：
- 在 `FactObservation` 增加 `dedup_key`（varchar 64）
- `UNIQUE(dedup_key)`
- 导入走批量 upsert（性能与一致性显著提升）

> 若你已做过 dedup_key，可在 PRD 中注明“已完成”，无需再加。

---

## 4. API 详细设计（新增/扩展）

### 4.1 图表模板 API（新增）
#### 4.1.1 `GET /api/v1/templates`
Query：
- `scope=mine|public|all`
- `chart_type=seasonality|timeseries`（可选）
返回：
```json
{
  "items":[{"id":1,"name":"标肥价差季节性","chart_type":"seasonality","is_public":0,"updated_at":"..."}]
}
```

#### 4.1.2 `POST /api/v1/templates`
Body：
- `name`
- `chart_type`
- `spec_json`
- `is_public`（仅 admin 生效）
返回：模板对象

#### 4.1.3 `PUT /api/v1/templates/{id}`、`DELETE /api/v1/templates/{id}`
权限：
- owner 可改/删自己的
- admin 可改/删公共模板

**验收点**
- 用户保存模板后，能通过 GET 取回并复现 chart spec
- 非 owner 删除应返回 403

---

### 4.2 Completeness API（新增）
#### `GET /api/v1/metadata/metrics/completeness`
Query：
- `as_of=YYYY-MM-DD`（缺省：数据库最新日期）
- `window=7|14|30`（缺省：7）
- `metric_group`（可选）
返回：
```json
{
  "as_of":"2026-02-01",
  "window":7,
  "summary":{"total":320,"ok":290,"late":30},
  "items":[
    {"metric_id":101,"metric_name":"全国标猪价格","latest_date":"2026-01-31","missing_days":0,"coverage_ratio":1.0},
    {"metric_id":205,"metric_name":"标肥价差(河南)","latest_date":"2026-01-28","missing_days":3,"coverage_ratio":0.57}
  ]
}
```

实现建议：
- 以 `FactObservation` 为源，按 metric_id 聚合 `max(obs_date)`、窗口内 `count(distinct obs_date)`
- `missing_days = window - present_days`（考虑自然日连续性：可选用 date spine 进一步精确）

---

### 4.3 TopN/异常 API（新增）
#### `POST /api/v1/query/topn`
Body：
- `metric_id` 或 `metric_group`
- `dimension`: `geo|company|warehouse`（或 null：不分组）
- `window_days`: 7/14/30
- `rank_by`: `delta|pct_change|seasonal_percentile|streak`
- `filters/tags_filter`（沿用现有）
- `topk`（默认 10）
返回：
```json
{
  "items":[
    {"name":"河南","latest":12.3,"delta":1.2,"pct_change":0.108,"rank":1},
    ...
  ],
  "meta":{"unit":"元/公斤","as_of":"2026-02-01"}
}
```

异常口径（一期内置）：
- `delta`: latest - value(window_days ago)
- `pct_change`: delta / abs(value(window_days ago))
- `seasonal_percentile`: 基于 seasonality 的历史分位（近 5 年同周/同日）
- `streak`: 连续上涨/下跌天数（仅对日度）

---

### 4.4 报告生成 API（新增）
#### 4.4.1 `GET /api/v1/reports/templates`
同 templates 思路：mine/public

#### 4.4.2 `POST /api/v1/reports/run`
Body：
- `template_id`
- `params_json`（年份、区间、维度、地区等）
返回：
- `run_id` + status

#### 4.4.3 `GET /api/v1/reports/run/{run_id}`
返回状态 + 下载链接（output_path）

报告模板（一期建议内置 2 套）：
- 周报-价差观察：标肥/毛白/区域价差（季节性 + 本年区间）
- 周报-价格与利润：全国价/重点省价/利润（季节性 + 区间）

---

## 5. ChartSpec（图表配置）规范（前后端契约）

### 5.1 seasonality spec
```json
{
  "chart_type":"seasonality",
  "metric_id":205,
  "years":[2021,2022,2023,2024,2025,2026],
  "x_mode":"week_of_year",
  "filters":{"geo_ids":[1], "company_ids":[], "warehouse_ids":[]},
  "tags_filter":{"pig_type":"标猪","weight_range":"110-125kg"},
  "agg":"mean"
}
```

### 5.2 timeseries spec
```json
{
  "chart_type":"timeseries",
  "metric_ids":[101,205],
  "start":"2025-02-01",
  "end":"2026-01-31",
  "time_dimension":"daily",
  "group_by":null,
  "filters":{"geo_ids":[1]},
  "tags_filter":{},
  "display":{"auto_dual_axis":true}
}
```

---

## 6. 权限设计（RBAC 最小闭环）
- viewer：只读（查询/导出）
- analyst：可查询/导出/保存个人模板
- admin：导入数据、发布公共模板、管理用户/报告模板

---

## 7. 非功能与运维建议（只列落地点）
- 导入性能：批量写入 + 去重键 upsert（避免 N×M 查询）
- JSON tags 过滤：MySQL 下统一 `JSON_UNQUOTE(JSON_EXTRACT())`
- 导出：文件路径按 run_id 分目录，定期清理或对象存储（可选）
- 日志：导入/导出/report_run 全链路记录 duration_ms 与错误摘要

---

## 8. 验收用例（关键）
1. 导入同一 Excel 两次：数据不膨胀（去重有效）
2. seasonality：标肥价差选择 2021-2026 年输出 6 条线，x=1..52
3. timeseries：选区间 + 两指标返回两条序列，单位不同自动双轴
4. completeness：能列出未更新到最新日期的指标 Top10
5. templates：保存/读取/删除/公共发布权限正确
6. report_run：选择周报模板一键导出可打开的 excel/zip

