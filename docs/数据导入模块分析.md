# 数据导入模块架构分析

## 一、整体流程

```
[Excel 文件] 
    → 前端 DataIngest.vue (上传 + 预览)
    → API /api/v1/ingest/execute
    → ingest_template_detector (模板识别)
    → 根据 template_type 路由到对应导入器
    → unified_import (统一工作流) 或 import_raw_only (仅 raw 层)
```

---

## 二、关键组件

### 1. 模板识别 `ingest_template_detector.py`

**职责**：根据文件名和 sheet 内容识别模板类型。

**支持的模板类型**：

| 模板类型 | 识别条件 | 导入方式 |
|---------|----------|----------|
| `INDUSTRY_DATA` | 文件名含「生猪产业数据」「产业数据」 | raw_only |
| `PREMIUM_DATA` | 文件名含「升贴水」「盘面结算价」 | raw_only |
| `ENTERPRISE_DAILY` | 文件名含「集团企业出栏跟踪」「分省区」 | unified_import |
| `ENTERPRISE_MONTHLY` | 文件名含「集团企业月度数据」 | raw_only |
| `WHITE_STRIP_MARKET` | 文件名含「白条市场跟踪」 | unified_import |
| `LH_FTR` | 期货相关、lh_ftr | 专用导入器 |
| `LH_OPT` | 期权相关 | 专用导入器 |
| `YONGYI_DAILY` | 涌益日度 | unified_import |
| `YONGYI_WEEKLY` | 涌益周度 | unified_import |
| `GANGLIAN_DAILY` | 第1行第1列为「钢联数据」 | unified_import |
| `LEGACY` | 默认兜底 | 可能报错 |

**常见问题**：
- 新文件若不符合上述规则，会被识别为 `LEGACY`，而 `ingest.py` 中未实现 `LEGACY` 分支，会抛出「不支持的模板类型」。
- 识别顺序固定，文件名优先级高于 sheet 内容。

---

### 2. 统一导入工作流 `unified_ingestor.py`

**流程**：

1. **创建 import_batch**，计算文件 hash
2. **保存 raw_file** 到本地存储
3. **加载 Profile**：按 `dataset_type` 从数据库查 `IngestProfile`，若不存在则从 `docs/ingest_profile_*.json` 自动加载
4. **保存 raw_sheet / raw_table**：遍历 workbook 的每个 sheet
5. **遍历 sheet**：
   - Dispatcher 分派 parser
   - 调用 parser 解析 → `observations`
   - Validator 验证
   - 若有 `table_config` → 导入到独立业务表 + fact_observation
   - 若无 → 仅导入 fact_observation
6. **extract_core_indicators**（指标抽取）
7. **更新 batch 状态**

**Profile 文件映射**（未入库时自动加载）：

```python
profile_file_map = {
    'YONGYI_WEEKLY': 'ingest_profile_yongyi_weekly_v1.json',
    'YONGYI_DAILY': 'ingest_profile_yongyi_daily_v1.json',
    'GANGLIAN_DAILY': 'ingest_profile_ganglian_daily_v1.json',
    'ENTERPRISE_DAILY': 'ingest_profile_enterprise_daily_v1.json',
    'WHITE_STRIP_MARKET': 'ingest_profile_white_strip_market_v1.json',
}
```

**常见问题**：
- 新 `dataset_type` 若未在上述 map 中，会报「未找到 profile」或「配置文件不存在」。
- `DimSource` 表需存在 `source_code`（如 YONGYI、GANGLIAN），否则 `load_profile_from_json` 会失败。

---

### 3. Dispatcher 与 Profile

**Dispatcher** (`dispatcher.py`)：
- 按 `sheet_name` 精确匹配 profile 中的 sheet 配置
- 未命中时用 `dispatch_rules`（`sheet_name_in`、`sheet_name_regex`、`has_columns`）匹配
- 返回 `action`：`SKIP_META` | `RAW_TABLE_STORE_ONLY` | `PARSE`
- 若为 `PARSE`，返回 `parser` 和 `sheet_config`

**Profile 结构**（`IngestProfile` + `IngestProfileSheet`）：
- `profile_code`, `profile_name`, `source_code`, `dataset_type`
- `sheets[]`：每个 sheet 有 `sheet_name`, `parser`, `action`, `config_json`
- `config_json` 含：`metric_template`、`table_config`、`column_mapping`、`unique_key` 等

**常见问题**：
- 新 sheet 未在 profile 中配置 → 默认 `RAW_TABLE_STORE_ONLY`，只存 raw 不解析
- `parser` 在 `PARSER_REGISTRY` 中不存在 → 报「未知的解析器类型」

---

### 4. Parser 注册表 `parsers/__init__.py`

**已注册解析器**：
- `P1` ~ `P9`：窄表、宽表、周期起止、钢联、企业日度、白条等
- 如：`NARROW_DATE_ROWS`、`WIDE_PROVINCE_ROWS_DATE_COLS`、`GANGLIAN_LEGACY_FORMAT`、`ENTERPRISE_DAILY`、`WHITE_STRIP_MARKET` 等

---

### 5. API 路由 `ingest.py`

**`/execute`**：根据 `template_type` 分支调用不同导入逻辑：

- `LH_FTR` / `LH_OPT`：专用导入器
- `YONGYI_DAILY` / `YONGYI_WEEKLY` / `GANGLIAN_DAILY` / `ENTERPRISE_DAILY` / `WHITE_STRIP_MARKET`：`unified_import`
- `INDUSTRY_DATA` / `PREMIUM_DATA` / `ENTERPRISE_MONTHLY`：`import_raw_only`

---

## 三、导入新数据的 checklist

若要导入**新的数据源/新模板**，需要：

1. **模板识别**  
   - 在 `ingest_template_detector.py` 中增加识别逻辑，或  
   - 前端预览时传入固定的 `template_type`。

2. **API 路由**  
   - 在 `ingest.py` 的 `execute_import` 中增加 `elif template_type == "NEW_TYPE"` 分支。

3. **Profile 配置**  
   - 新增 `docs/ingest_profile_xxx_v1.json`  
   - 在 `unified_ingestor.py` 的 `profile_file_map` 中增加映射  
   - 或先运行脚本把 profile 写入数据库。

4. **数据源**  
   - 确保 `dim_source` 中存在对应 `source_code`。

5. **解析器**  
   - 若表结构特殊，需新增 parser 并注册到 `PARSER_REGISTRY`；  
   - 若与现有格式相似，可复用已有 parser，在 profile 的 sheet 配置中指定。

6. **Sheet 配置**  
   - 为每个需解析的 sheet 在 profile 中配置 `sheet_name`、`parser`、`metric_template` / `table_config` 等。

---

## 四、调试建议

1. **查看后端控制台**：`unified_import` 会打印每个 sheet 的处理过程（解析器、记录数、错误等）。
2. **查看批次详情**：导入后在「批次详情」中查看 `errors` 列表。
3. **检查 Profile**：确认 `ingest_profile` 和 `ingest_profile_sheet` 中是否有对应 `dataset_type` 和 `sheet_name`。
4. **检查 raw 层**：`raw_file`、`raw_sheet`、`raw_table` 可确认文件是否被正确保存和分 sheet。
