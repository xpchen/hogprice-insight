# hogprice-insight 五类数据全量入库与展示改进计划（含涌益日/周重点）

> 目标：把 **5 类数据源（DCE LH期货、DCE LH期权、钢联价格模板、涌益日度、涌益周度）** 全量入库，并按“**数据源 → 数据集 → 指标（含地域/时间/维度）**”统一建模，让客户默认进入即可看到核心看板，并支持按区域/时间/维度钻取。

---

## 0. 现状与痛点（基于你当前 schema + 后端代码）

你当前库里已经有：

- `fact_futures_daily` / `fact_options_daily`：可承接 LH 期货/期权（结构基本够）。
- `fact_indicator_ts`：支持 **daily/weekly**（`trade_date` / `week_start` / `week_end`）且有唯一键。
- `fact_observation(tags_json, raw_value, dedup_key)`：天然适合“涌益这种复杂维度”。
- 后端已实现 `yongyi_daily_ingestor` / `yongyi_weekly_ingestor`，但**主要写入 `fact_indicator_ts`**，复杂维度（规模场/小散/体重段/交割城市/情绪等）会丢失或无法规范查询。

**痛点：**
1. **复杂维度无法完整表达**：涌益日/周中存在“日期跨列 + 子列（规模场/小散/均价/涨跌）+ 文本维度（体重段/情绪）+ 城市交割”等。
2. **地理层级不足**：目前主要是省级（`dim_region`/`dim_geo`），但日度存在“交割地市（城市/县）”。
3. **映射配置分散**：当前用 `indicator_mappings.json` 做映射，后期维护与版本迭代成本高。
4. **全量入库与首页展示之间缺一层“抽取/汇总”**：你需要既能全量保存，又能快速展示核心指标。

---

## 1. 目标架构（你提到的：数据源 → 数据 → 指标 + 地域 + 时间）

### 1.1 分层模型（强烈建议）
- **Source（数据源层）**：DCE / 钢联 / 涌益
- **Dataset / Batch（数据集层）**：每次上传/抓取形成一个批次（文件哈希、时间范围、状态、错误）
- **Observation（全量事实层，承接复杂维度）**：一条观测 = `metric + time(含周期) + geo/location + tags + value/raw`
- **Indicator（展示层）**：将核心 metric 按固定口径映射为 `indicator_code`，落 `fact_indicator_ts` 用于看板快速查询

> 原则：**全量入库走 Observation；首页/客户展示走 Indicator**。两层同时维护，互不拖累。

---

## 2. 数据建模改造（DDL级改进建议）

> 尽量在你现有 schema 上“增量改造”，避免推倒重来。

### 2.1 新增/增强维表

#### (A) `dim_source`（统一数据源）
用于统一管理：名称、类型、更新频率、授权说明等，并与 batch/metric/indicator 关联。

关键字段：
- `source_code` (PK)：`DCE` / `MYSTEEL` / `YONGYI`
- `source_name`、`update_freq`、`source_type`、`license_note`

#### (B) 地理：新增 `dim_location` + `dim_location_alias`
为解决“交割地市出栏价”等城市级数据。

- `dim_location`：`location_code`、`level(province/city/county)`、`parent_code`、`name_cn`
- `dim_location_alias`：`alias` + `source_code` → `location_code`

> 省级数据可以继续用 `dim_region`（region_code），也可以逐步迁移到 `dim_location`（province level）。

#### (C) 指标体系：新增 `metric_alias`（或入库到 DB 的映射规则）
把 Excel 表头/字段名映射到稳定的 `metric_code/metric_id`。

字段建议：
- `source_code`
- `sheet_name`
- `alias_text`（原始口径字符串）
- `metric_id`
- `tags_patch_json`（这个 alias 固定附带的 tags，如 `scale=规模场`）

### 2.2 Observation 事实层增强（全量入库关键）

你现有 `fact_observation` 已很接近可用，但建议补齐“周期”与“可索引 tags”。

#### (A) 为周度/月度补“周期字段”
```sql
ALTER TABLE fact_observation
  ADD COLUMN period_type VARCHAR(10) NULL,
  ADD COLUMN period_start DATE NULL,
  ADD COLUMN period_end DATE NULL,
  ADD INDEX idx_obs_period (period_type, period_end);
```

#### (B) 新增 `fact_observation_tag`（高性能维度筛选）
```sql
CREATE TABLE fact_observation_tag (
  observation_id BIGINT NOT NULL,
  tag_key VARCHAR(64) NOT NULL,
  tag_value VARCHAR(128) NOT NULL,
  PRIMARY KEY (observation_id, tag_key),
  INDEX idx_tag_kv (tag_key, tag_value),
  INDEX idx_tag_kv_obs (tag_key, tag_value, observation_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### (C) Raw 溯源：新增 `raw_file`（或 `ingest_file`）
记录：文件名、hash、时间范围、来源、解析版本、存储路径等；并让 observation/indicator 关联到 raw_file/batch。

字段建议：
- `id`
- `batch_id`
- `filename`
- `file_hash`
- `report_date`
- `date_range_start` / `date_range_end`
- `parser_version`
- `created_at`

> 有了 raw_file，你才能做到：回放、对比两次导入差异、重跑解析、审计追溯。

---

## 3. 五类数据全量入库方案（逐类落库策略）

### 3.1 DCE 生猪期货（LH_FTR）
**落库：**
- `dim_contract`：补齐 `exchange`、`listed_date`、`last_trading_day`（可后置）
- `fact_futures_daily`：按 `contract_id + trade_date` upsert

**展示：**
- 看板：主力合约、各合约 K线、成交量/持仓量、基差（后续做派生）
- 指标层：可选抽取“主力收盘价/成交量/持仓量”等到 `fact_indicator_ts`

### 3.2 DCE 生猪期权（LH_OPT）
**落库：**
- `dim_option`：补 `expiry_date`、`multiplier`、`exercise_style`（可后置）
- `fact_options_daily`：按 `option_id + trade_date` upsert

**展示：**
- IV 曲线、成交/持仓、行权量、Delta 分布（按行权价/到期日）

### 3.3 钢联价格模板（GANGLIAN_DAILY）
以 `分省区猪价` 为核心：行=日期，列=指标（带省份）。
**导入：**
- 解析前 4 行元信息（指标名称/单位/更新时间）
- 将列名拆解为：
  - `metric`（如“商品猪出栏均价”）
  - `geo`（中国/黑龙江/…）
  - `freq`（日/周）
- **全量写入 `fact_observation`**（tags 记录 freq/单位），并同步抽取核心到 `fact_indicator_ts`。

### 3.4 涌益日度（YONGYI_DAILY）——重点
日度文件包含 8 个 sheet，表型分 4 类：

1) **出栏价（多级表头：日期跨列 + 子列：规模场/小散户/均价/涨跌）**
- metric：`hog_out_price`
- tags：
  - `scale`：规模场/小散户/均价
  - `field`：price / delta
- geo：省份
- time：trade_date（日）

2) **各省份均价（日期行 + 省份列）**
- metric：`hog_out_price`
- tags：`scale=均价`（或 `stat=avg`）
- geo：省份
- time：trade_date

3) **屠宰企业日度屠宰量（省份行 + 日期列）**
- metric：`slaughter_qty`
- geo：省份；合计行 geo=全国
- time：trade_date

4) **交割地市出栏价（省份分组 + 升贴水/交易均重元数据 + 日期×城市价格矩阵）**
- 必须先有 `dim_location(city)` + alias
- 拆成 3 个 metric：
  - `delivery_city_price`（日期×城市）
  - `delivery_premium_lh2505_plus`（城市静态/准静态，可按 report_date 入库）
  - `delivery_premium_lh2409_2503`
  - `delivery_trade_weight_band`（文本，存 raw_value）
- tags：`province`、`contract_range`、`weight_band`

5) **散户标肥价差 / 市场主流标猪肥猪价格**
- 既有数值（价差/均价），也有文本（体重段/情绪）
- 数值 → `value`
- 文本 → `raw_value`（必要时扩 `value_text`）

> 关键点：日度必须走 `fact_observation`，否则维度一定丢。

### 3.5 涌益周度（YONGYI_WEEKLY）——重点
周度文件 sheet 数多（65+），建议按“表型”自动分派解析器：

- **W1：周起始/结束 + 省份列宽表**（如 周度-商品猪出栏价、周度-冻品库存、周度-猪肉价…）
  - period_type=week
  - period_start/period_end
  - geo=省份
  - metric=按 sheet 固定

- **W2：周起始/结束 + 规模段/模式列**（周度-养殖利润最新）
  - tags：`scale_band`、`mode=自繁自养/外购仔猪/合同农户`
  - geo=全国（或后续扩到区域）

- **W3：单日期长表（周度-毛白价差）**
  - obs_date=日期
  - metric 拆 3 列：白条价/出栏价/价差（或一个 metric 多 field tag）

- **W4：周度文件里嵌“日度矩阵”（周度-屠宰企业日度屠宰量）**
  - 这其实是日度数据：period_type=day，obs_date=日期

- **月度/历史矩阵（如 周度-养殖利润、月度-…）**
  - period_type=month
  - 拆年月 → month_end
  - 先全量入 observation，展示层后置

> 全量入库策略：**所有数值类 sheet 都入 `fact_observation`；文本类（说明/目录/数据说明）跳过。**

---

## 4. 导入系统改造（后端）

你后端已有 ingest API 与模板识别，建议升级为“配置驱动 + 全量 observation + 指标抽取”。

### 4.1 新增 ingest_profile（模板化）
- `ingest_profile`：一个数据源模板（如 `YONGYI_DAILY_V1` / `YONGYI_WEEKLY_V1`）
- `ingest_profile_sheet`：每个 sheet 的解析规则（表型、header 行、日期规则、字段/维度规则）

**收益：**
- 下次涌益新增 sheet/改表头，你只改配置，不改代码。

### 4.2 解析器（Parser）拆分为 6 个通用组件
- `P1_wide_date_columns`：日期行 + 省份列
- `P2_wide_province_columns`：日期列 + 省份列（屠宰量那种）
- `P3_multiheader_date_group`：日期跨列 + 子列（出栏价/标肥价差）
- `P4_week_start_end_province_wide`：周起止 + 省份列（周度多数）
- `P5_week_start_end_dim_wide`：周起止 + 规模段/模式列（利润最新）
- `P6_delivery_city_matrix`：交割地市（省份分组 + 元数据 + 城市矩阵）

### 4.3 幂等与修订（必须）
- `dedup_key = sha1(source + metric + geo/location + date/period_end + canonical_tags)`
- upsert：同 dedup_key 覆盖（保留最新）
- 如需保留历史修订：追加 `revision` 或写 history 表（第二阶段再做）

---

## 5. 指标层（fact_indicator_ts）抽取策略：保证“客户可看”且性能好

### 5.1 统一指标字典（dim_indicator）
每个“要展示的指标”给一个稳定 code，例如：
- `yongyi_hog_out_price_avg`（全国/省份）
- `yongyi_slaughter_qty_total`
- `yongyi_cold_stock`
- `yongyi_breeding_profit`
- `mysteel_hog_out_price_avg`
- `dce_lh_main_close`

### 5.2 从 observation → indicator 的抽取规则
- 只抽“固定口径”：
  - 例如 `hog_out_price` 且 `scale=均价`
  - `slaughter_qty` 的合计
  - 周度的 `week_end`
- 抽取任务可以做成：
  - 导入后同步触发（小批量）
  - 或定时任务（大批量/回补）

你仓库里已有 `scripts/calculate_all_metrics.py`，可以扩为“抽取/汇总”的统一入口。

---

## 6. 前端展示改造（让五类数据都能给客户看）

### 6.1 左侧菜单建议（按数据域重组）
1) **总览 Dashboard**（默认首页）
2) **现货价格**
   - 涌益日度出栏价（规模场/小散/均价切换）
   - 钢联分省区猪价
3) **屠宰与需求**
   - 日屠宰量（全国/省份）
4) **库存与白条**
   - 冻品库存（周度）
   - 白条价、毛白价差（周度）
5) **利润与成本**
   - 养殖利润最新（周度，按规模段/模式筛选）
6) **期货（DCE）**
   - 主力/合约行情、成交/持仓
7) **期权（DCE）**
   - IV、成交/持仓、行权量、Delta
8) **交割地市**
   - 城市出栏价（可叠加升贴水/交易均重信息）

### 6.2 交互统一：四个核心筛选器
- 数据源：涌益/钢联/交易所
- 时间：日/周/月 + 日期范围
- 地域：全国/大区/省/市（交割）
- 口径维度（来自 tags）：规模场/小散/体重段/模式等

> 这些筛选器需要 `fact_observation_tag` 的索引支持，否则会卡。

---

## 7. 迁移与实施里程碑（建议 4 个阶段）

### Phase 1：数据模型补齐（1～2天）
- 增加：`dim_source`、`dim_location(+alias)`、`raw_file`、`fact_observation_tag`
- `fact_observation` 增加周期字段
- 编写 alembic migration + `scripts/run_migration.*` 接入

### Phase 2：全量导入（重点：涌益日/周）（3～6天）
- 实现 6 类 parser
- 建立 `ingest_profile` 配置（至少覆盖你当前两份涌益文件所有 sheet）
- 全量写入 `fact_observation` + 写入 `fact_observation_tag`
- 保持现有 `fact_indicator_ts` 写入（抽取核心指标）

### Phase 3：钢联模板全量入库 + 指标抽取（1～2天）
- 钢联 7 个 sheet 全量导入 observation
- 抽取核心指标到 indicator_ts（省份均价/毛白价差/利润周度等）

### Phase 4：前端看板与钻取（3～5天）
- 首页：关键 KPI + 趋势 + 地图/排行
- 现货/屠宰/库存/利润/期货/期权页面
- 指标点击 → Drill down 到 observation（维度筛选）

---

## 8. 关键风险与对策

1) **Excel 表头变化**：用 `ingest_profile` 配置化；并保留 raw_file 以便重跑。
2) **非数值字段（情绪/体重段）**：统一存 `raw_value`，必要时扩 `value_text`。
3) **数据量大**：优先依赖 `fact_observation(metric_id, obs_date)` + `fact_observation_tag` 索引；必要时按年分区（第二阶段）。
4) **区域别名**：必须建立 `dim_location_alias`/`dim_region_alias`，导入时先归一化。

---

## 9. 你现在就能开始的“最小落地步骤”
1) 先上 **Phase 1** 的 4 张表/字段（不影响现有功能）。
2) 先把 **涌益日度 8 个 sheet** 全量入 observation（Phase 2 的一半），首页先展示：全国均价、屠宰量、各省均价趋势。
3) 再导入 **涌益周度 W1/W2/W3/W4 表型**，优先展示：周度出栏价、冻品库存、毛白价差、养殖利润最新。

---

如果你愿意，我可以在下一步把 **“ingest_profile 配置（覆盖你这两份涌益 Excel 的全部 sheet）”** 直接按 sheet 输出成可落库的 JSON，并明确：
- 每个 sheet 属于哪个 parser（P1~P6）
- metric_id / tags 规范
- 需要新增的 location/alias 列表（交割城市）
- 导入后抽取到 indicator_ts 的核心指标清单
