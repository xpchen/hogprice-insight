# E3. 供需曲线 - 长周期猪价推演 需求对接完成总结

## 一、需求概述

完成E3. 供需曲线 - 长周期猪价推演的需求对接，使用【生猪产业数据】.xlsx文件中的"供需曲线"sheet作为数据源。

## 二、数据源分析

### 2.1 Excel文件位置
- 文件路径：`docs/生猪/2、【生猪产业数据】.xlsx`
- Sheet名称：`供需曲线`

### 2.2 数据结构

**定点屠宰部分（第2-14行）**：
- 第2行：表头（年份列：2019年-2025年，均值，比率列）
- 第3-14行：1-12月的定点屠宰数据
- 包含各年份的屠宰量和比率（当月/均值）

**猪价部分（第16-28行）**：
- 第16行：表头（年份列：2019年-2025年，均值，比率列）
- 第17-28行：1-12月的猪价数据
- 包含各年份的猪价和比率（当月/均值）

**时间序列数据（第31行开始）**：
- 第30行：表头（"画图区域数值"）
- 第31行开始：时间序列格式的数据
- 数据格式：每3列为一组
  - 第1列：日期（YYYY-MM-DD格式）
  - 第2列：定点屠宰系数
  - 第3列：猪价系数
- 多组数据横向排列（2019年、2020年、2021年等）

### 2.3 数据示例

```
行31: B列=2019-01-31, C列=0.9413(屠宰系数), D列=0.529(价格系数)
       E列=2020-01-31, F列=0.5837(屠宰系数), G列=1.5391(价格系数)
       H列=2021-01-31, I列=0.7547(屠宰系数), J列=1.5388(价格系数)
```

## 三、实现方案

### 3.1 API修改

**文件**：`backend/app/api/supply_demand.py`

**修改内容**：
1. 修改`get_supply_demand_curve`函数，优先从"供需曲线"sheet读取数据
2. 解析第31行开始的时间序列数据
3. 提取日期、定点屠宰系数、猪价系数
4. 如果"供需曲线"sheet不存在，回退到原来的逻辑（从fact_observation计算）

### 3.2 数据解析逻辑

1. **读取raw_table数据**：从数据库中读取"供需曲线"sheet的原始数据
2. **解析时间序列**：从第31行（索引30）开始解析
3. **列组解析**：每3列为一组（日期、屠宰系数、价格系数）
4. **日期解析**：支持多种日期格式（ISO格式、字符串格式等）
5. **数据去重**：按月份（YYYY-MM）去重，保留最新数据
6. **数据排序**：按月份排序返回

### 3.3 数据验证

**测试结果**：
- ✓ 成功解析79个数据点
- ✓ 数据时间范围：2019-01 至 2025-07
- ✓ 数据格式正确：包含定点屠宰系数和猪价系数

**示例数据**：
```
2019-01: 屠宰系数=0.9413, 价格系数=0.529
2019-02: 屠宰系数=0.7895, 价格系数=0.5431
...
2025-07: 屠宰系数=1.6423, 价格系数=0.6736
```

## 四、数据导入状态

### 4.1 导入检查

**检查脚本**：`backend/scripts/check_supply_demand_curve_sheet.py`

**检查结果**：
- ✓ "供需曲线"sheet已导入到数据库
- ✓ Sheet ID: 805
- ✓ 文件ID: 81
- ✓ 文件名: 2、【生猪产业数据】.xlsx
- ✓ 数据行数: 94行

### 4.2 导入方式

如果数据未导入，可以运行：
```bash
python backend/scripts/import_industry_data.py
```

该脚本会导入整个【生猪产业数据】.xlsx文件的所有sheet，包括"供需曲线"sheet。

## 五、API接口

### 5.1 接口信息

**端点**：`GET /api/v1/supply-demand/curve`

**响应模型**：`SupplyDemandCurveResponse`

**响应结构**：
```json
{
  "data": [
    {
      "month": "2019-01",
      "slaughter_coefficient": 0.9413,
      "price_coefficient": 0.529
    },
    ...
  ],
  "latest_month": "2025-07"
}
```

### 5.2 数据字段说明

- `month`: 月份（格式：YYYY-MM）
- `slaughter_coefficient`: 定点屠宰系数（当月/平均值）
- `price_coefficient`: 猪价系数（月度均值/历年平均值）
- `latest_month`: 最新数据月份

## 六、前端对接

### 6.1 前端组件

**文件**：`frontend/src/views/official-data/SupplyDemandCurve.vue`

**功能**：
- 图表1：长周期生猪供需曲线（定点屠宰系数、猪价系数）
- 图表2：能繁母猪存栏&猪价（滞后10个月）
- 图表3：新生仔猪&猪价（滞后10个月）

### 6.2 API调用

**文件**：`frontend/src/api/supply-demand.ts`

**接口**：`getSupplyDemandCurve()`

前端已配置好API调用，数据会自动从新的数据源获取。

## 七、测试验证

### 7.1 测试脚本

**文件**：`backend/scripts/test_supply_demand_curve_api.py`

**测试结果**：
- ✓ 数据解析成功
- ✓ 共79个数据点
- ✓ 数据时间范围正确
- ✓ 数据格式正确

### 7.2 验证步骤

1. 运行测试脚本验证数据解析：
   ```bash
   python backend/scripts/test_supply_demand_curve_api.py
   ```

2. 启动后端服务，测试API接口：
   ```bash
   curl http://localhost:8000/api/v1/supply-demand/curve
   ```

3. 在前端页面查看图表显示是否正常

## 八、完成状态

### 8.1 已完成

- ✅ Excel文件结构分析
- ✅ 数据解析逻辑实现
- ✅ API接口修改
- ✅ 数据导入验证
- ✅ 测试脚本编写
- ✅ 数据解析测试通过

### 8.2 待验证

- ⏳ 前端页面显示验证
- ⏳ 完整数据流测试
- ⏳ 性能测试（数据量大时）

## 九、相关文件

### 9.1 后端文件

- `backend/app/api/supply_demand.py` - API实现
- `backend/scripts/analyze_supply_demand_curve_sheet.py` - Sheet结构分析脚本
- `backend/scripts/analyze_supply_demand_curve_detailed.py` - 详细分析脚本
- `backend/scripts/check_supply_demand_curve_sheet.py` - 数据导入检查脚本
- `backend/scripts/test_supply_demand_curve_api.py` - API测试脚本
- `backend/scripts/import_industry_data.py` - 数据导入脚本

### 9.2 前端文件

- `frontend/src/views/official-data/SupplyDemandCurve.vue` - 前端组件
- `frontend/src/api/supply-demand.ts` - API客户端

### 9.3 数据文件

- `docs/生猪/2、【生猪产业数据】.xlsx` - 数据源文件

## 十、注意事项

1. **数据更新**：如果Excel文件更新，需要重新运行导入脚本
2. **数据格式**：确保Excel文件中的"供需曲线"sheet格式保持一致
3. **日期格式**：代码支持多种日期格式，但建议使用标准格式（YYYY-MM-DD）
4. **数据去重**：如果同一月份有多条数据，会保留最后一条
5. **回退机制**：如果"供需曲线"sheet不存在，API会回退到原来的计算逻辑

## 十一、后续优化建议

1. **数据缓存**：可以考虑添加Redis缓存，提高查询性能
2. **数据验证**：添加更严格的数据验证，确保数据质量
3. **错误处理**：完善错误处理机制，提供更友好的错误信息
4. **数据监控**：添加数据更新监控，及时发现数据问题
5. **性能优化**：如果数据量很大，可以考虑分页或限制查询范围
