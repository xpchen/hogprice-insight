# 生猪行情洞察系统升级完成说明

## 升级概述

本次升级完成了系统的全面重构，包括：
1. 统一的数据模型架构
2. 新的原始数据导入系统
3. 默认首页看板
4. 前端菜单重组和权限控制
5. 数据对账功能

## 数据库迁移

### 1. 运行迁移脚本

```bash
cd backend
alembic upgrade head
```

这将创建所有新表：
- `dim_indicator` - 指标维度表
- `dim_region` - 区域维度表
- `dim_contract` - 期货合约维度表
- `dim_option` - 期权合约维度表
- `fact_indicator_ts` - 指标时序事实表
- `fact_indicator_metrics` - 指标预计算metrics表
- `fact_futures_daily` - 期货日度数据表
- `fact_options_daily` - 期权日度数据表
- `ingest_error` - 导入错误表
- `ingest_mapping` - 导入映射表

### 2. 初始化基础数据

```bash
cd backend
python scripts/init_base_data.py
```

这将初始化：
- 全国、大区、省份的区域数据
- 常用指标的定义（价格、屠宰、均重、价差、冻品、产业链）

### 3. 迁移旧数据（可选）

如果需要从旧的 `fact_observation` 表迁移数据：

```bash
cd backend
python scripts/migrate_to_new_schema.py
```

## 新功能使用指南

### 1. 原始数据导入

访问路径：`数据中心 > 原始数据导入`

支持的数据源：
- **LH_FTR**: 生猪期货日历史行情 (`lh_ftr.xlsx`)
- **LH_OPT**: 生猪期权日历史行情 (`lh_opt.xlsx`)
- **YONGYI_DAILY**: 涌益咨询日度数据
- **YONGYI_WEEKLY**: 涌益咨询周度数据

导入流程：
1. 上传Excel文件
2. 系统自动识别模板类型
3. 预览数据结构和样本
4. 执行导入
5. 查看批次详情和错误报告

### 2. 默认首页看板

访问路径：`看板 > 行情总览`

包含7个卡片：
1. **全国出栏均价 + 标肥价差** - 双轴图表
2. **日度屠宰量季节性** - 支持农历对齐
3. **价格&屠宰走势** - 年度筛选
4. **均重专区** - 6个指标入口
5. **价差专区** - 3个指标入口
6. **冻品库容率** - 分省区季节性
7. **产业链周度汇总** - 养殖利润和全价料价格

### 3. 数据对账

访问路径：`数据中心 > 入库对账`

功能：
- **缺失日期检查**: 检查指定指标在时间范围内的缺失日期
- **重复记录检查**: 查找重复的数据记录
- **异常值检查**: 基于统计方法检测异常值（标准差倍数）

### 4. 统一时序接口

新的API端点：`/api/v1/ts`

替代旧的 `/api/v1/query/timeseries`，支持：
- 指标代码查询
- 区域筛选
- 频率筛选（日频/周频）
- 日期范围筛选
- 可选预计算metrics（同比/环比/变化量）

### 5. 期货/期权查询

- **期货**: `/api/v1/futures/daily` - 查询期货日度数据
- **期权**: `/api/v1/options/daily` - 查询期权日度数据

## 前端菜单结构

### A. 看板（所有用户可见）
- 行情总览（默认首页）
- 价格
- 屠宰
- 均重
- 冻品
- 产业链

### B. 期货期权（所有用户可见）
- 生猪期货
- 生猪期权

### C. 分析与预警（所有用户可见）
- 多维分析
- 图表配置
- 模板中心

### D. 报表与导出（所有用户可见）
- 报告生成

### E. 数据中心（仅管理员/运营可见）
- 原始数据导入
- 入库对账
- 数据导入（旧）

### F. 系统管理（仅管理员可见）
- 模板管理

## 预计算服务

系统支持自动计算指标的预计算metrics：
- 1日/5日/10日/30日变化量
- 同比（YoY）
- 环比（MoM）

运行批量计算：
```bash
cd backend
python scripts/calculate_all_metrics.py
```

## 农历对齐功能

日度数据支持农历对齐，用于季节性分析。

需要安装农历库：
```bash
pip install lunar-python
```

如果不安装，系统会使用简化实现。

## 配置文件

### 指标映射配置
`backend/app/data/indicator_mappings.json` - 定义Excel字段到指标代码的映射

### 指标视图配置
`frontend/src/config/indicator_view_config.json` - 定义前端展示配置

## API文档

启动后端服务后，访问：
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

## 注意事项

1. **数据迁移**: 旧数据迁移是可选步骤，新系统可以独立运行
2. **文件存储**: 当前导入系统直接处理文件内容，如需持久化存储需要扩展
3. **权限控制**: 确保用户角色正确配置（admin/operator/customer）
4. **农历库**: 农历对齐功能需要 `lunar-python` 库，否则使用简化实现
5. **指标初始化**: 根据实际数据源，可能需要补充更多指标定义

## 故障排查

### 导入失败
1. 检查文件格式是否正确
2. 查看批次详情中的错误列表
3. 确认指标映射配置是否正确

### 看板无数据
1. 确认已导入数据
2. 检查指标代码是否正确
3. 查看API返回的错误信息

### 权限问题
1. 确认用户角色配置
2. 检查前端菜单权限判断逻辑
3. 查看后端API权限装饰器

## 后续优化建议

1. **文件存储系统**: 实现文件持久化存储
2. **导入调度**: 支持定时自动导入
3. **数据校验增强**: 更完善的业务规则校验
4. **性能优化**: 大数据量查询优化
5. **缓存机制**: 看板数据缓存
6. **导出功能**: 对账结果导出Excel
